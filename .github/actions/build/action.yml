name: "Build Module"
author: IrateRedKite
description: "Composite action for building and releasing a Module"

runs:
  using: composite
  steps:
    - name: Checkout
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
      
    - name: Build module
      uses: Ardesco/nasher4gh@v1
      with:
        args: '[''pack'', ''--default'', ''-usenwnscriptcomp'']'

    - name: "Get current date and release notes"
      id: date
      shell: bash
      run: |
        echo "::set-output name=date::$(date +''%Y-%m-%d-%H-%M'')"
        BODY=$(git log ${GITHUB_REF##*/} --since='24 hours ago' | sed -En 's/^ +?([a-z]+:\w*)/\1/p' | awk '{print "- "$0}')
        printf '%s\n' "${BODY[@]}" | tac > RELEASE.MD

    - name: Compress module
      id: compress
      shell: bash
      run: |
        7z a -t7z -mx=9 -mtm- Release-${{ steps.date.outputs.date }}.7z *.mod README.md LICENSE
        
    - name: "Create Release"
      id: create_release
      uses: ncipollo/release-action@v1
      with:
        artifacts: "${{ github.workspace }}/*.7z"
        bodyFile: "RELEASE.MD"
        tag: nightly-${{ steps.date.outputs.date }}
